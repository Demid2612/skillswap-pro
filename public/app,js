const API_URL = "https://skillswap-pro.onrender.com"; // твой домен Render

let currentUser = null;
let selectedUserId = null;

// ===== РЕГИСТРАЦИЯ =====
async function registerUser() {
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();

  if (!name  !email  !password) {
    alert("Заполни все поля!");
    return;
  }

  const res = await fetch(`${API_URL}/api/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, email, password })
  });

  const data = await res.json();

  if (!res.ok) {
    alert("Ошибка регистрации: " + data.error);
    return;
  }

  alert("Регистрация успешна!");
}

// ===== ВХОД =====
async function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!email || !password) {
    alert("Введите email и пароль!");
    return;
  }

  const res = await fetch(`${API_URL}/api/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();

  if (!res.ok) {
    alert("Ошибка входа: " + data.error);
    return;
  }

  currentUser = data.user;

  document.getElementById("auth").style.display = "none";
  document.getElementById("chat").style.display = "block";
  document.getElementById("userName").innerText = currentUser.name;

  loadUsers();
  setInterval(loadMessages, 2000);
}

// ===== Список пользователей =====
async function loadUsers() {
  const res = await fetch(`${API_URL}/api/users`);
  const users = await res.json();

  let html = "";
  users.forEach(u => {
    if (u.id !== currentUser.id) {
      html += <div onclick="openChat('${u.id}')">${u.name}</div>;
    }
  });

  document.getElementById("users").innerHTML = html;
}

function openChat(id) {
  selectedUserId = id;
  loadMessages();
}

// ===== ОТПРАВКА СООБЩЕНИЯ =====
async function sendMsg() {
  if (!selectedUserId) return;

  const text = document.getElementById("msgText").value.trim();
  if (!text) return;
  document.getElementById("msgText").value = "";

  await fetch(`${API_URL}/api/message`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fromId: currentUser.id,
      toId: selectedUserId,
      text
    })
  });

  loadMessages();
}

// ===== Получение сообщений =====
async function loadMessages() {
  if (!selectedUserId) return;

  const res = await fetch(
    ${API_URL}/api/messages?a=${currentUser.id}&b=${selectedUserId}
  );
  const msgs = await res.json();

  let html = "";
  msgs.forEach(m => {
    html += `<div>${m.time} | ${
      m.fromId === currentUser.id ? "Вы" : "Друг"
    }: ${m.text}</div>`;
  });

  document.getElementById("messages").innerHTML = html;
}
