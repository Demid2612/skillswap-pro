console.log("App loaded");

let currentUser = null;
let selectedUserId = null;

// ===== РЕГИСТРАЦИЯ =====
async function registerUser() {
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();

  if (!name  !email  !password) {
    alert("Заполни все поля");
    return;
  }

  const res = await fetch("/api/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, email, password })
  });

  const data = await res.json();
  if (!res.ok) return alert(data.error);

  alert("Успешная регистрация!");
}

// ===== ВХОД =====
async function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!email || !password) {
    alert("Введите данные");
    return;
  }

  const res = await fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();
  if (!res.ok) return alert(data.error);

  currentUser = data.user;
  document.getElementById("auth").style.display = "none";
  document.getElementById("chat").style.display = "block";
  document.getElementById("userName").innerText = currentUser.name;

  loadUsers();
  setInterval(loadMessages, 2000);
}

// ===== СПИСОК ПОЛЬЗОВАТЕЛЕЙ =====
async function loadUsers() {
  const res = await fetch("/api/users");
  const users = await res.json();
  const box = document.getElementById("users");

  box.innerHTML = users
    .filter(u => u.id !== currentUser.id)
    .map(u => `<div onclick="openChat('${u.id}')">${u.name}</div>`)
    .join("");
}

function openChat(id) {
  selectedUserId = id;
  loadMessages();
}

// ===== ОТПРАВКА СООБЩЕНИЯ =====
async function sendMsg() {
  const text = document.getElementById("msgText").value.trim();
  if (!text || !selectedUserId) return;
  document.getElementById("msgText").value = "";

  await fetch("/api/message", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fromId: currentUser.id,
      toId: selectedUserId,
      text
    })
  });

  loadMessages();
}

// ===== ЗАГРУЗКА СООБЩЕНИЙ =====
async function loadMessages() {
  if (!selectedUserId) return;
  const res = await fetch(`/api/messages?a=${currentUser.id}&b=${selectedUserId}`);
  const msgs = await res.json();

  document.getElementById("messages").innerHTML = msgs
    .map(m => `<div>${m.time} | ${m.fromId === currentUser.id ? "Вы" : "Друг"}: ${m.text}</div>`)
    .join("");
}
