let currentUser = null;
let selectedUserId = null;

// ===== РЕГИСТРАЦИЯ =====
async function registerUser() {
  try {
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value.trim();

    if (!name  !email  !password) {
      alert("Заполни все поля для регистрации");
      return;
    }

    const res = await fetch("/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email, password })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      alert("Ошибка регистрации: " + (data.error || res.status));
      return;
    }

    alert("Регистрация успешна! Теперь войди через форму Вход.");
    document.getElementById("name").value = "";
    document.getElementById("regEmail").value = "";
    document.getElementById("regPassword").value = "";
  } catch (err) {
    console.error(err);
    alert("Ошибка сети при регистрации: " + err.message);
  }
}

// ===== ВХОД =====
async function login() {
  try {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!email || !password) {
      alert("Введи email и пароль");
      return;
    }

    const res = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const text = await res.text();
    let data = {};
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("Ответ не JSON:", text);
    }

    if (!res.ok || data.error) {
      alert("Ошибка входа: " + (data.error || res.status));
      return;
    }

    currentUser = data.user;

    document.getElementById("auth").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("userName").innerText =
      currentUser.name + (currentUser.premium ? " ⭐" : "");

    loadUsers();
    setInterval(loadMessages, 1500);
  } catch (err) {
    console.error(err);
    alert("Ошибка сети при входе: " + err.message);
  }
}

// ===== ЗАГРУЗКА ПОЛЬЗОВАТЕЛЕЙ =====
async function loadUsers() {
  if (!currentUser) return;

  try {
    const res = await fetch("/api/users");
    const users = await res.json();
    let html = "";
    users.forEach((u) => {
      if (u.id !== currentUser.id) {
        html += `<div onclick="openChat('${u.id}')">
          ${u.name} ${u.premium ? "⭐" : ""}
        </div>`;
      }
    });
    document.getElementById("users").innerHTML = html;
  } catch (err) {
    console.error(err);
  }
}

function openChat(id) {
  selectedUserId = id;
  loadMessages();
}

// ===== ОТПРАВКА СООБЩЕНИЯ =====
async function sendMsg() {
  if (!selectedUserId || !currentUser) return;

  const text = document.getElementById("msgText").value.trim();
  if (!text) return;

  document.getElementById("msgText").value = "";

  try {
    await fetch("/api/message", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fromId: currentUser.id,
        toId: selectedUserId,
        text
      })
    });
    loadMessages();
  } catch (err) {
    console.error(err);
    alert("Ошибка при отправке сообщения: " + err.message);
  }
}

// ===== ЗАГРУЗКА СООБЩЕНИЙ =====
async function loadMessages() {
  if (!selectedUserId || !currentUser) return;

  try {
    const res = await fetch(
      /api/messages?a=${currentUser.id}&b=${selectedUserId}
    );
    const msgs = await res.json();

    let html = "";
    msgs.forEach((m) => {
      html += `<div>${m.time} | ${
        m.fromId === currentUser.id ? "Вы" : "Друг"
      }: ${m.text}</div>`;
    });

    document.getElementById("messages").innerHTML = html;
  } catch (err) {
    console.error(err);
  }
}
